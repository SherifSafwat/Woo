@model Woo.ViewModels.InvoiceViewModel

@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Woo</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
</head>

<body>
    <div class="container">
        <main role="main" class="pb-3">

            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div>

                    <!-- ---------------------  -->
                    <!-- Invoice Head           -->
                    <!-- ---------------------  -->

                    @if (@ViewBag.customer)
                    {
                        <div class="form-group  col-md-4">
                            <label asp-for="invoiceH.CustomerObj.EName" class="control-label"></label>
                            <select asp-for="invoiceH.CustomerId" class="form-control"
                                    asp-items="@(new SelectList(@ViewBag.customerlist, "CustomerId", "EName"))">
                            </select>
                            <span asp-validation-for="invoiceH.CustomerId" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <input type="hidden" asp-for="invoiceH.CustomerId" value="0" />
                    }

                    <div class="form-group col-md-4">
                        <label asp-for="invoiceH.InvoiceTime" class="control-label"></label>
                        <input asp-for="invoiceH.InvoiceTime" class="form-control" readonly />
                        <span asp-validation-for="invoiceH.InvoiceTime" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="invoiceH.Total" class="control-label"></label>
                        <input asp-for="invoiceH.Total" class="form-control"  readonly />
                        <span asp-validation-for="invoiceH.Total" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="invoiceH.TotalTax" class="control-label"></label>
                        <input asp-for="invoiceH.TotalTax" class="form-control"  readonly />
                        <span asp-validation-for="invoiceH.TotalTax" class="text-danger"></span>
                    </div>

                </div>

                <!-- ---------------------  -->
                <!-- Invoice Tail           -->
                <!-- ---------------------  -->

                <hr />

                <div class="table-responsive">
                    <table class="table table-bordered" id="dynamic_field" name="dynamic_field">
                        <tr class="invoice_row" id="row0">
                            <td class="d-none"><input type="text" id="itemid0" name="itemid" class="form-control" /></td>
                            <td><input type="text" id="itemnum0" name="itemnum" class="form-control" /></td>
                            <td><input type="text" id="name0" name="name" class="form-control" readonly /></td>
                            <td><input type="text" id="price0" name="price" class="form-control" readonly /></td>
                            <td><input type="text" id="qty0" name="qty" class="form-control" /></td>
                            <td><input type="text" id="tot0" name="tot" class="form-control" readonly /></td>
                            <td><button type="button" id="remove0" name="remove" class="btn btn-danger btn_remove"> X </button></td>
                        </tr>
                    </table>
                </div>

                <div class="form-group">
                    <input type="button" id="add" name="add" value="Add Item" class="btn btn-primary" />
                </div>

                <div class="form-group">
                   <input type="button" value="Create" class="btn btn-primary btn_post" />
                    @*<button type="button" value="Create" class="btn btn-primary"  onclick="location.href='@Url.Action("Create", "Invoices")'" >Create</button>*@
                </div>
                <div>
                    <a asp-controller="Home" asp-action="Index">Cancel</a>
                </div>


            </form>

        </main>
    </div>

    <!-- ---------------------  -->
    <!-- Items Model            -->
    <!-- ---------------------  -->

    <div class="modal fade" tabindex="-1" id="ItemsModal" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        &times;
                    </button>
                    @*<h4 class="modal-title">Login</h4>*@
                </div>
                <div class="modal-body">
                    <form asp-action="Items" method="post">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Item Id</th>
                                        <th>Item Name</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in (List<Item>)ViewBag.itemlist)
                                    {
                                        <tr class="item_row" id="@item.ItemId">
                                            <td>@Html.DisplayFor(modelItem => item.ItemNum)</td>
                                            <td>@Html.DisplayFor(modelItem => item.EName)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </form>

                    @*<div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Ok</button>
                            <button type="button" id="btnHideModal" class="btn btn-primary">
                                Close
                            </button>
                        </div>*@
                </div>
            </div>
        </div>
    </div>


@*<footer class="border-top footer text-muted">
<div class="container">
&copy; 2020 - Woo - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
</div>
</footer>*@


    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @*@RenderSection("Scripts", required: false)*@

    @section Scripts {
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    }



    <script>

    function onloadxx() {

        var now = new Date();
        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);
        var today = now.getFullYear() + "-" + (month) + "-" + (day);

        $('#invoiceH_InvoiceTime').val(today);
        $('#invoiceH_Total').val(0);
        $('#invoiceH_TotalTax').val(0);

        $('#itemnum0').focus();
    };

    function ajax1(p_rowid, p_itemid) {

        $.ajax({
            type: "POST",
            url: "@Url.Action("ItemInfo")",
            data: { id: p_itemid },
            dataType: "json",
            success: function (data) {

                $('#itemid' + p_rowid + '').val(data[0].id);
                $('#itemnum' + p_rowid + '').val(data[0].itemnum);
                $('#name' + p_rowid + '').val(data[0].name);
                $('#price' + p_rowid + '').val(data[0].price);

                $('#qty' + p_rowid + '').focus();

                return data;
            },
            error: function (req, status, error) {
                alert(error);
            }
        });
    }


    function addrow(p_rowid) {

        //$('#dynamic_field').append(' <tr id="' + _i + '"> <td class="d-none"><input type="text" id="itemid' + _i + '" name="itemid" value="" class="form-control" /></td> <td><input type="text" id="itemnum' + _i + '" name="itemnum" value="" class="form-control" /></td> <td><input type="text" id="name' + _i + '" name="name" value="" class="form-control" /></td> <td><input type="text" id="price' + _i + '" name="price" value="" class="form-control" /></td> <td><input type="text" id="qty' + _i + '" name="qty" class="form-control" /></td> <td><button type="button" id="remove' + _i + '" name="remove" class="btn btn-danger btn_remove"> X </button></td> </tr> ');
        //$('#dynamic_field').append('<tr class="invoice_row" id="row' + p_rowid + '"> <td class="d-none"><input type="text" id="itemid' + p_rowid + '" name="itemid" class="form-control" /></td> <td><input type="text" id="itemnum' + p_rowid + '" name="itemnum" class="form-control" /></td> <td><input type="text" id="name' + p_rowid + '" name="name" class="form-control" readonly  /></td> <td><input type="text" id="price' + p_rowid + '" name="price" class="form-control" readonly  /></td> <td><input type="text" id="qty' + p_rowid + '" name="qty" class="form-control" /></td> <td><button type="button" id="' + p_rowid + '" name="remove" class="btn btn-danger btn_remove"> X </button></td> </tr> ');

        $('#dynamic_field').append('<tr class="invoice_row" id="row' + p_rowid + '"> \
                                    <td class="d-none"><input type="text" id="itemid' + p_rowid + '" name="itemid" class="form-control" /></td> \
                                    <td><input type="text" id="itemnum' + p_rowid + '" name="itemnum" class="form-control" /></td> \
                                    <td><input type="text" id="name' + p_rowid + '" name="name" class="form-control" readonly  /></td> \
                                    <td><input type="text" id="price' + p_rowid + '" name="price" class="form-control" readonly  /></td> \
                                    <td><input type="text" id="qty' + p_rowid + '" name="qty" class="form-control" /></td> \
                                    <td><input type="text" id="tot' + p_rowid + '" name="tot" class="form-control" readonly /></td> \
                                    <td><button type="button" id="' + p_rowid + '" name="remove" class="btn btn-danger btn_remove"> X </button></td> </tr> ');

        $('#itemnum' + p_rowid + '').focus();

    }

    function disableinputs(p_rowid) {
        $('#itemnum' + p_rowid + '').prop('readonly', true);
        $('#qty' + p_rowid + '').prop('readonly', true);

        var i = Number($('#invoiceH_Total').val());

        $('#tot' + p_rowid + '').val(Number($('#price' + p_rowid + '').val()) * Number($('#qty' + p_rowid + '').val()) );
        $('#invoiceH_Total').val(i + Number($('#tot' + p_rowid + '').val())).toFixed(2);
        $('#invoiceH_TotalTax').val(Number($('#invoiceH_Total').val()) * 0.1).toFixed(2);

    }

    ///////////// Events ////////////////////////

    $(document).ready(function () {

        var _linesno = 0;

        onloadxx();

        $("#add").click(function () {
            $("#ItemsModal").modal('show');
        });

        $("#btnHideModal").click(function () {
            $("#ItemsModal").modal('hide');
        });

        $(document).on('click', '.btn_remove', function (e) {
            var button_id = $(this).attr("id");

            var i = Number($('#invoiceH_Total').val());
            $('#invoiceH_Total').val( i - Number($('#tot' + button_id + '').val())).toFixed(2);
            $('#invoiceH_TotalTax').val(Number($('#invoiceH_Total').val()) * 0.1).toFixed(2);

            $('#row' + button_id + '').remove();
        });

        $(document).on('click', '.btn_post', function (e) {
            if ($('#invoiceH_Total').val().length === 0) {
                alert("No Invoice Rows");
            }
            else {
                this.form.submit();
            }
        });

        $(document).on('click', '.item_row', function () {
            var itemid = $(this).attr("id");

            $("#ItemsModal").modal('hide');
            ajax1(_linesno, itemid)

        });

        //$("#dynamic_field").keypress(function (e) {
        $(document).on('keypress', '.invoice_row', function (e) {
            if (e.keyCode == 13) {
                if (document.activeElement.name == "itemnum") { ajax1(_linesno, document.activeElement.value); }
                if (document.activeElement.name == "qty") { disableinputs(_linesno); _linesno++;  addrow(_linesno);  }
            }
        });

        //$(document).on('keypress', function (e) {
        //    if (e.keyCode == 13) {
        //        alert('Enter key pressed!');
        //    }
        //});

    });

    </script>

</body>
</html>

